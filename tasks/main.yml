---
# tasks file for opdk-setup-component
- block:
  - name: Setup Apigee component for version {{ opdk_version }} or greater - {{ profile }}
    shell: '{{ apigee_setup }} -p {{ profile }} -f {{ opdk_installation_config_file }}'
    when: opdk_version | version_compare('4.16.01', '>=')
    register: setup

  rescue:

    - name: Rebooting node because selinux is not disabled
      shell: 'reboot now'
      when: "{{ ansible_selinux.status | lower != 'disabled' }}"

    - name: Wait for node to restart
      wait_for:
        state: started
        port: 22

    - name: Setup Apigee component for version {{ opdk_version }} or greater - {{ profile }}
      shell: '{{ apigee_setup }} -p {{ profile }} -f {{ opdk_installation_config_file }}'
      when: opdk_version | version_compare('4.16.01', '>=')
      register: setup

- name: Obtain server self report - {{ profile }}
  ignore_errors: yes
  opdk_server_self:
    server_type: '{{ profile }}'
    username: '{{ opdk_user_email }}'
    password: '{{ opdk_user_pass }}'
  when: '{{ server_type is defined }}'
